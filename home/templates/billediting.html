{% extends 'index.html' %}
{% block content %}
{% load static %}


 <div class="page-wrapper">
                <div class="content container-fluid">
                    <div class="page-header invoices-page-header">
                        <div class="row align-items-center">
                            <div class="col">
                                <ul class="breadcrumb invoices-breadcrumb">
                                    <li class="breadcrumb-item invoices-breadcrumb-item">
                                        <a href="{% url 'home:itemreturn' %}">
                                            <i class="fe fe-chevron-left"></i> Back to Invoice List
                                        </a>
                                    </li>
                                </ul>
                            </div>
 
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card invoices-add-card">
                                <div class="card-body">
                                    <form action="#" class="invoices-form">
                                        <div class="invoices-main-form">
                                            <div class="row">
                                                <div class="col-xl-4 col-md-6 col-sm-12 col-12">
                                                    <div class="form-group">
                                                        <label>
                                                            Phone Number
                                                        </label>
                                                        <input type="text"
                                                                class="form-control"
                                                                id="phone"
                                                                name="phone"
                                                                value="{{bill.client.phone_no}}" readonly>

                                                        
                                                    </div>
                                                    <div class="form-group">
                                                        <label>
                                                            Customer Name
                                                        </label>
                                                    
                                                        <input class="form-control"
                                                         type="text"
                                                         value="{{bill.client.client_name}}"
                                                         readonly>
                                                    </div>
                                                </div>
                                                <div class="col-xl-5 col-md-6 col-sm-12 col-12">
                                                    <h4 class="invoice-details-title">
                                                        Invoice details
                                                    </h4>
                                                    <div class="invoice-details-box">
                                                        <div class="invoice-inner-head">
                                                            Invoice No.<span > {{bill.billing_no}}</span>
                                                        </div>
                                                        <div class="invoice-inner-footer">
                                                            <div class="row align-items-center">
                                                                <div class="col-lg-12 col-md-12">
                                                                    <div class="invoice-inner-date">
                                                                        <span>
                                                                            Date:-
                                                                            <input class="form-control " type="text" value="{{bill.billing_date}}" readonly>
                                                                        </span>
                                                                    </div>
                                                                    
                                                                </div>
                                                               
                                                            </div>
                                                        </div>
                                                        
                                                    </div>
  
                                                </div>
                                                
                                            </div>
                                        </div>
                                        <div class="invoice-item">
                                            <div class="row">
                                                <div class="col-xl-4 col-lg-6 col-md-6">
                                                    <div class="invoice-info">
                                                        <strong class="customer-text">Invoice From </strong>
                                                        <p class="invoice-details invoice-details-two">
                                                            Darren Elder
                                                            <br>
                                                            806 Twin Willow Lane, Old Forge,
                                                            <br>
                                                            Newyork, USA
                                                            <br>
                                                            9987654567
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="invoice-add-table">
                                            <h4>
                                                Item Details
                                            </h4>
                                            <div class="table-responsive">
                                                <table class="table table-center add-table-items">
                                                    <thead>
                                                        <tr>
                                                            <th>
                                                                Item Name
                                                            </th>
                                                            <th>
                                                                Category
                                                            </th>
                                                            <th>
                                                                Quantity
                                                            </th>
                                                            <th>
                                                                Price/Day
                                                            </th>
                                                            <th>
                                                                Date
                                                            </th>
                                                           
                                                            <th>
                                                                Actions
                                                            </th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                       

                                                        <!-- --------------------- -->
                                                        {% for i in items %}
                                                        <tr class="add-row">
                                                            <td>
                                                                <input type="text"
                                                                  class="form-control invid{{forloop.counter}} "
                                                                  name="item"
                                                                  id=""
                                                                  readonly
                                                                  value="{{i.item_name}}">
                                                                  
                                                                <datalist id="stock">
                                                                    {% for c in stock  %}
                                                                        <option value="{{c.item_name}}">
                                                                            {{c.item_name}}
                                                                        </option>
                                                                    {% endfor %}
                                                                </datalist>
                                                              </td>
                                                 
                                                            <td>
                                                                <input type="text" id="" class="form-control " readonly value="{{i.category}}">
                                                                <input type="text" id="" class="form-control" value="{{bill.id}}" hidden > 
                                                            </td>
                                                            <td>
                                                                <input type="number" id="" class="form-control qty{{forloop.counter}}"  readonly value="{{i.qty}}">
                                                                <!-- <input type="number" id="qty{{forloop.counter}}" class="form-control"  readonly value="{{i.qty}}"> -->
                                                            </td>
                                                            <td>
                                                                <input type="number" id="item_price" class="form-control"  readonly value="{{i.rental_price}}">
                                                            </td>
                                                            <td>
                                                                <input type="text" id="" class="form-control"  readonly value="{{i.billing_date}}">
                                                                <input type="number" id="amount{{forloop.counter}}" class="form-control"  readonly value="{{i.aggregate}}" hidden >
                                                                <!-- <input type="number" id="existrow" class="form-control"  readonly value="{{forloop.counter}}" hidden> -->
                                                                
                                                            </td>
                                                            
                                                            <td class="add-remove text-end">
                                                                <a href="javascript:void(0);" id="add" onclick="addate()" class="add-btn me-2"><i
                                                                        class="fas fa-plus-circle"></i></a>                        
                                                                <a href="javascript:void(0);" class="remove-btn"><i
                                                                        class="fa fa-trash"></i></a>

                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                        <!-- --------------------- -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-lg-7 col-md-6">                                               
                                            </div>
                                            <div class="col-lg-5 col-md-6">
                                                <div class="invoice-total-card">
                                                    <h4 class="invoice-total-title">
                                                        Summary
                                                    </h4>
                                                    <div class="invoice-total-box">
                                                        <div class="invoice-total-inner">
                                                            <p>
                                                                No of Items <span id="rowcount">0</span>
                                                            </p>
                                                            <div class="links-info-one">
                                                                <div class="links-info">
                                                                    <div class="links-cont">
                                                                        <a href="#" class="service-trash">
                                                                            <i class="feather-trash-2"></i>
                                                                        </a>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="links-info-discount">
                                                                <div class="links-cont-discount">
                                                                    
                                                                    <a href="#" class="service-trash-one">
                                                                        <i class="feather-trash-2"></i>
                                                                    </a>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="invoice-total-footer">
                                                            <h4>
                                                                Amount per Day <span >₹<span id="total_amt"></span></span>
                                                            </h4>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="upload-sign">
                                                    <div class="form-group float-end mb-0">
                                                        <button class="btn btn-primary" id="generatebuttonadd" type="submit">
                                                            Save Invoice
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
<script src="{% static 'js/feather.min.js' %}"></script>
{% endblock %}

{% block js %}

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="{% static 'plugins/select2/js/select2.min.js' %}"></script>
<script src="{% static 'plugins/moment/moment.min.js' %}"></script>

<script>
        $(".add-table-items").on('click','.remove-btn', function () {
		$(this).closest('.add-row').remove();
		return false;
    });
    
   
$(document).on("click", ".add-btn", function () {
    var rowCount = $(".add-table-items tr").length;
    
    var experiencecontent = '<tr class="add-row">' +
        '<td>' +
        '<input type="text" list="stock" id="item' + rowCount + '" onChange="changedname(' + rowCount + ')" class="form-control productname">' +
        '</td>' +
        '<td>' +
        '<input type="text" id="item_category' + rowCount + '" class="form-control" readonly>' +
        '<input type="number" list="stock" id="invid"  class="form-control productname" value="{{bill.id}}" hidden>' +
        '</td>' +
        '<td>' +
        '<input type="number" id="qty' + rowCount + '" onChange="changedqty(' + rowCount + ')" class="form-control qty' + rowCount + '" min="1" >' +
        '</td>' +
        '<td>' +
        '<input type="number" id="item_price' + rowCount + '" class="form-control" readonly>' +
        '</td>' +
        '<td>' +
        '<input type="text" id="datenow' + rowCount + '" class="form-control" readonly >' +
        '<input type="number" id="amount' + rowCount + '" class="form-control"  hidden >' +
        '</td>' +
        '<td class="add-remove text-end">' +
        '<a href="javascript:void(0);" onclick="addate(' + rowCount + ')" class="add-btn me-2"><i class="fas fa-plus-circle"></i></a> ' +
        '<a href="javascript:void(0);" onclick="DeleteRow(' + rowCount + ')" class="remove-btn"><i class="fas fa-trash"></i></a>' +
        '</td>' +
        '</tr>';

    $(".add-table-items").append(experiencecontent);

    return false;
});
</script>

<script>
    $('body').append('<div class="sidebar-overlay"></div>');
	$(document).on('click', '#mobile_btn', function () {
		$wrapper.toggleClass('slide-nav');
		$('.sidebar-overlay').toggleClass('opened');
		$('html').toggleClass('menu-opened');
		return false;
	});


</script>
<script>
    $(document).on('click', '#toggle_btn', function () {
		if ($('body').hasClass('mini-sidebar')) {
			$('body').removeClass('mini-sidebar');
			$('.subdrop + ul').slideDown();
		} else {
			$('body').addClass('mini-sidebar');
			$('.subdrop + ul').slideUp();
		}
		setTimeout(function () {
			mA.redraw();
			mL.redraw();
		}, 300);
		return false;
	});
	
	$(document).on('mouseover', function (e) {
		e.stopPropagation();
		if ($('body').hasClass('mini-sidebar') && $('#toggle_btn').is(':visible')) {
			var targ = $(e.target).closest('.sidebar').length;
			if (targ) {
				$('body').addClass('expand-menu');
				$('.subdrop + ul').slideDown();
			} else {
				$('body').removeClass('expand-menu');
				$('.subdrop + ul').slideUp();
			}
			return false;
		}
	});
</script>
<script>

    // customer name and phone number

        
    function changedname(id){
    
            $.ajax({
                url:'/itemsearch',
                type:'GET',
                data:{
                    'itemname':$("#item" + id).val()  
                },
                success:function(response){
                    $('#item_category'+id).val(response.item)
                    $('#item_price'+id).val(response.rentalprice)
                    $('#qty' +id).attr("max",response.max_qty)
                    $('#datenow' ).val(response.date)
  
                }
            })

        }

    function changedqty(rowCount){
        var qty = parseInt($('.qty'+rowCount).val())
        var price = parseInt($('#item_price'+rowCount).val())
        // print('qty',qty)

        var amount = qty*price

        $('#amount'+ rowCount).val(amount)

        amount_vrb = $('#amount'+ rowCount).val(amount)

        var Available_rowCount = $(".add-table-items tr ").length;
        var sum = 0
        for(var i=1;i<Available_rowCount;i++){
        sum+=parseInt($('#amount'+i).val())
        // console.log(parseInt(sum)) 


        }
        $('#rowcount').html(parseInt(Available_rowCount - 1))
        $('#total_amt').html(parseInt(sum))
    }
    
    function DeleteRow(id){

        var completeTotal =0
        var count = parseInt($('#rowcount').html())
        var amount=parseInt($("#amount" + id).val())
        var total=parseInt($("#total_amt").html())
        completeTotal = parseInt(total)  - amount
        var row_count =  count - 1
        $("#total_amt").html(completeTotal)
        $("#rowcount").html(row_count)

        }


//multilple adding


$('#generatebuttonadd').click(function () {
    var invid = $('#invid').val()
     
    var rowCount = $(".add-table-items tr").length;

    for (var i = 1; i < rowCount; i++) {
        var item = $('#item' + i).val()
        var qty = $('#qty' + i).val()
        var dates = $('#dates' + i).val()

        var data = {
            "invid": invid,
            "item": item,
            "qty": qty,
            "dates":dates,
            
        }
        
        $.ajax({
            url: "/newbilladding",
            type: 'POST',
            data: data,
            success: function (responce) {
                
                swal('saved successfully')

            },
            error: function(jqXHR,error, errorThrown){
               swal('Error')
            }

        })

    }
    
    return false;
})



function addate(id){
    let today = new Date().toISOString().slice(0, 10)   
    var date=$("#datenow"+ id).val(today)
   
}

    </script>

{% endblock  %}